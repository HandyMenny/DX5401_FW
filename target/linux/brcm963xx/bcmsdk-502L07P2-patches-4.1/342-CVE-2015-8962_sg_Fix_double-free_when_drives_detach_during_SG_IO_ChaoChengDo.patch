Index: linux-4.1.52/drivers/scsi/sg.c
===================================================================
--- linux-4.1.52.orig/drivers/scsi/sg.c	2018-05-28 10:26:45.000000000 +0800
+++ linux-4.1.52/drivers/scsi/sg.c	2021-10-01 14:48:10.418779469 +0800
@@ -823,8 +823,14 @@
 		return k;	/* probably out of space --> ENOMEM */
 	}
 	if (atomic_read(&sdp->detaching)) {
-		if (srp->bio)
+		if (srp->bio) {
+			if (srp->rq->cmd != srp->rq->__cmd)
+				kfree(srp->rq->cmd);
+
 			blk_end_request_all(srp->rq, -EIO);
+			srp->rq = NULL;
+		}
+
 		sg_finish_rem_req(srp);
 		sg_remove_request(sfp, srp);
 		return -ENODEV;
